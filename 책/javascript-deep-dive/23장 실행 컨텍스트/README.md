# 23장 실행 컨텍스트

# 1. 소스코드의 타입

- ECMAScript 사양은 소스코드(ECMAScript code)를 4가지 타입으로 구분한다.
    
    **1) 전역 코드(global code)**
    
    - 전역에 존재하는 소스코드
    - 전역에 정의된 함수, 클래스 드으이 내부코드는 포함되지 않는다.
    - 최상위 스코프인 전역스코프를 생성하고, 전역 코드가 평가되면 전역 실행 컨텍스트가 생성된다.
    - var 키워드, 함수 선언문으로 정의된 전역 함수를 전역 객체의 프로퍼티와 메서드로 바인딩한다.


    **2) 함수 코드(function code)**
    
    - 함수 내부에 존재하는 소스코드
    - 함수 내부에 중첩된 함수, 클래스 등의 내부 코드는 포함되지 않는다.
    - 지역 스코프를 생성하고 지역변수, 매개변수, arguments 객체를 관리해야 한다.
    - 지역 스코프를 전역 스코프에서 시작하는 스코프 체인의 일원으로 연결한다.
    
    **3) eval 코드(eval code)**
    
    - 빌트인 전역 함수인 eval 함수에 인수로 전달되어 실행되는 소스코드
    
    **4) 모듈 코드(module code)**
    
    - 모듈 내부에 존재하는 소스코드
    - 모듈 내부의 함수, 클래스 등의 내부 코드는 포함되지 않는다.

<br />

# 2. 소스코드의 평가와 실행

- 모든 소스코드는 실행에 앞서 평가 과정을 거치며 코드를 실행하기 위한 준비를 한다.
    
    ⇒ 소스코드의 **평가**와 **실행** 과정으로 나누어 처리한다.
    

- 평가 과정
    - 실행 컨텍스트를 생성하고 변수, 함수 등의 선언문만 먼저 실행하여 생성된 변수나 함수 식별자를 키로 실행 컨텍스트가 관리하는 스코프에 등록한다.
    - 평가 과정이 끝나면 비로소 선언문을 제외한 소스코드가 순차적으로 실행되기 시작한다.
        
        ⇒ 런타임 시작
        
    

```jsx
var x;
x = 1;
```

- 위 코드가 실행되면 `var x;` 를 먼저 실행해서 undefined가 초기화된다.(소스코드의 평가)
- 이후 실행 과정에서는 변수 할당문인 `x = 1;` 만 실행된다.

<br />

# 3. 실행 컨텍스트의 역할

```jsx
// 전역 변수 선언
const x = 1;
const y = 2;

// 함수 정의
function foo(a) {
  // 지역 변수 선언
  const x = 10;
  const y = 20;

  // 메서드 호출
  console.log(a + x + y); // 130
}

// 함수 호출
foo(100);

// 메서드 호출
console.log(x + y); // 3
```

<br />

## 3-1) 전역 코드 평가

- 전역 코드를 실행하기에 앞서 먼저 전역 코드 평가 과정을 거치며 전역 코드를 실행하기 위한 준비를 한다.
- 소스코드 평가 과정에서는 **선언문만 먼저 실행**한다.
    - 따라서 전역 코드의 변수 선언문과 함수 선언문이 먼저 실행된다.
    - 이때 var, 함수 선언문 은 전역 객체의 프로퍼티와 메서드가 된다.

<br />

## 3-2) 전역 코드 실행

- 전역 코드의 평가 과정이 끝나면 런타임이 시작되어 전역 코드가 순차적으로 실행되기 시작한다.
- 이때 전역 **변수에 값이 할당**되고 **함수가 호출**된다.
- **함수가 호출되면** 순차적으로 실행되던 **전역 코드의 실행을 일시 중단**하고 코드 실행 순서를 변경하여 **함수 내부로 진입**한다.

<br />

## 3-3) 함수 코드 평가

- 함수 호출에 의해 코드 실행 순서가 변경되어 함수 내부로 진입하면 함수 코드 평가 과정을 거친다.
- 매개변수와 지역 변수 선언문이 먼저 실행되고 생성된 매개변수와 지역 변수가 실행 컨텍스트가 관리하는 지역 스코프에 등록된다.
- 함수 내부에 arguments 객체가 생성되어 지역 스코프에 등록되고 this 바인딩도 결정된다.

<br />

## 3-4) 함수 코드 실행

- 함수 코드가 순차적으로 실행되고, 매개변수와 지역 변수에 값이 할당된다.

⇒ 코드가 실행되려면 스코프, 식별자, 코드 실행 순서 등의 관리가 필요한데 이것이 실행 컨텍스트다.

- 실행 컨텍스트는 식별자를 등록하고 관리하는 스코프와 코드 실행 순서 관리를 구현한 내부 메커니즘으로, 모든 코드는 실행 컨텍스트를 통해 실행되고 관리된다.

<br />

# 4. 실행 컨텍스트 스택

- 자바스크립트 엔진은 전역 코드를 평가하여 전역 실행 컨텍스트를 생성한다.
- 그리고 함수가 호출되면 함수 코드를 평가하여 함수 실행 컨텍스트를 생성한다.
- 이때 생성된 실행 컨텍스트는 스택 자료구조로 관리된다.

```jsx
const x = 1;

function foo () {
  const y = 2;

  function bar () {
    const z = 3;
    console.log(x + y + z);
  }
  bar();
}

foo(); // 6
```

1. 전역 코드의 평가와 실행
2. foo 함수 코드의 평가와 실행
3. bar 함수 코드의 평가와 실행
4. foo 함수 코드로 복귀
5. 전역 코드로 복귀

스택

1. []
2. [전역 실행 컨텍스트]
3. [전역 실행 컨텍스트, foo 함수 실행 컨텍스트]
4. [전역 실행 컨텍스트, foo 함수 실행 컨텍스트, bar 함수 실행 컨텍스트]
5. [전역 실행 컨텍스트, foo 함수 실행 컨텍스트]
6. [전역 실행 컨텍스트]
7. []

<br />

# 5. 렉시컬 환경

- 렉시컬 환경은 식별자와 식별자에 바인딩된 값, 그리고 상위 스코프에 대한 참조를 기록하는 자료구조로 실행 컨텍스트를 구성하는 컴포넌트다.
- 실행 컨텍스트가 코드의 **실행 순서**를 관리 | 렉시컬 환경은 **스코프와 식별자**를 관리
- 키와 값을 갖는 객체 형태의 스코프를 생성하여 식별자를 키로 등록하고 식별자에 바인딩된 값을 관리한다.
